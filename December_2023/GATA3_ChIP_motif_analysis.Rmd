---
title: GATA3_ChIP_motif_analysis
header-includes:
- \usepackage{color}
- \usepackage{float}
- \DeclareUnicodeCharacter{2212}{-}
date: "December 19, 2023"
output:
  bookdown::html_document2:
    toc: true
fontsize: 14pt
geometry: margin=1in

---

```{css, echo=FALSE}
body .main-container {
  max-width: 1200px !important;
  width: 1200px !important;
}
body {
  max-width: 1200px !important;
}

pre {
  max-height: 600px;
  overflow-y: auto;
}

pre[class] {
  max-height: 600px;
}
```

```{css, echo=FALSE}
.watch-out {
  background-color: lightcyan;
  border: 3px solid lightgrey;
  font-weight: bold;
}

.revision {
  background-color: #FFF4F2;
  border: 3px solid lightgrey;
  font-weight: bold;
}

.highlighted
{
   color:red;
}

.highlighted2
{
  color:blue
}
```

```{r engine='R', eval=TRUE, echo=F}
knitr::opts_chunk$set(class.source = "watch-out")
```


# Exhaustive MEME -MAST for GATA3

```{r engine='R', eval=TRUE, echo=F}
knitr::opts_chunk$set(class.source = "revision")
```

## Previous Workflow Summary

In previous analysis, I have used a 3-ordered Markov Background Model, which defined all k-mer frequencies up to 4-mer. \
Then I sort the top 10000 GATA peaks (with 101bp window centered around the peak summit). \
I use MEME to find the top 1 motif with `-minw 4` and `-maxw 20`. \
 \
If the de novo motif match to GATA3, I use `MAST` to query that single motif (meme.txt) from the complete GATA3 peak sets (101bp window), and find motif coordinates relative to peak regions. \
Then I use `intersectBed` with `-v` option to find peak regions without that motif. \
This new sets of peaks (without first GATA3-like motif) will then be used to do another round of MEME analysis. (sorting 10000, MEME, MAST, intersectBed) \
... \
... \
In the case that the top de novo motif do not match with GATA3, I will first increase number of motif we ask MEME to search for (`-nmotifs` from 1 to 2/3). If the second or third motif match to GATA3, we repeat the same analysis; if we still not see GATA3-like motifs, we move to the software **STREME**. \
... \
... \

When we are sure of we have exhaustive the MEME analysis to GATA3 peaks, and could not find more de novo motifs that match with GATA3, we use **`STREME`**, which is typically good for searching short de novo sequences. \
STREME can work with larger amount of sequences with a fast speed (compared to MEME), so for each round of STREME, we use all peaks (without the already found GATA3-like motifs) and search for top 10 enriched motifs. \
Similar as in MEME analysis, if any de novo motif in that 10 enriched STREME motifs match to GATA3, I use `MAST` to query that single motif (meme.txt) from the GATA3 peak sets (101bp window), and find motif coordinates relative to peak regions. \

If at a point, we could not find GATA3-like motifs use STREME in central 101bp window, we will try find motifs at the spanned region. \
... \
... \

Besides these, I also tried to use the 2-ordered Markov Background Model, and see if this could increase the chance MEME or STREME find GATA3-like de novo motifs. \

## New workflow

```{r  out.width = "80%", echo=F, fig.align = "center", fig.cap="GATA3 motif analysis workflow"}
library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/workflow_GATA3_motif_analysis.png") 
```


# 3-ordered Markov Background Model

GATA3 TF binding sites are short, commonly seen are 3-mer GAT/ATC or 4-mer GATA/GATC. \
To account for this fact, we want to generate the markov background model from the reference genome, which estimates the probability of a candidate motif appearing in the dataset by chance. \

I use `fasta-get-markov` with `-m 3` option to generate a 3-ordered Markov Background Model for hg38 ref genome. The output file defines all k-mer frequencies from 1-mer to 4-mer. \

```{r, engine='bash', eval=F, echo=TRUE}
module load meme/5.4.1
module load bedtools
module load R/4.1.2

genome=/home/FCAM/ssun/Genome/hg38.fa
sizes=/home/FCAM/ssun/Genome/hg38.chrom.sizes

fasta-get-markov -m 3 $genome > hg38_bkgrnd.txt
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
head Exhaustive_MEME_MAST_round1to8/hg38_bkgrnd.txt
tail Exhaustive_MEME_MAST_round1to8/hg38_bkgrnd.txt
```

### load packages
```{r, engine='bash', eval=F, echo=TRUE}
module load deeptools/3.5.0
module load meme/5.4.1
module load bedtools
module load R/4.1.2
genome=/home/FCAM/ssun/Genome/hg38.fa
sizes=/home/FCAM/ssun/Genome/hg38.chrom.sizes
dir=/home/FCAM/ssun/GATA3_ChIP_PRO_July2023/ChIP_final/peak_call/
```


## MEME-round1:

### find de novo motifs
**Sort** peaks by intensity, and select top 10,000 peaks. \
```{r, engine='bash', eval=F, echo=TRUE}
name=GATA_ChIP
# sort out the top 10000 GATA peaks and search for top 1 motif
sort -nrk5,5 ${dir}${name}_summit_100window.bed | head -n 10000 > ${name}_top10000_summit_100window.bed
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/GATA_ChIP_summit_100window.bed
head -5 Exhaustive_MEME_MAST_round1to8/GATA_ChIP_summit_100window.bed
wc -l Exhaustive_MEME_MAST_round1to8/GATA_ChIP_top10000_summit_100window.bed
head Exhaustive_MEME_MAST_round1to8/GATA_ChIP_top10000_summit_100window.bed
```

Convert this top 10,000 peak bed file to **.fasta** file with `fastaFromBed`. \
```{r, engine='bash', eval=F, echo=TRUE}
name=${name}_top10000
fastaFromBed -fi $genome -bed ${name}_summit_100window.bed -fo ${name}_summit_100window.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/GATA_ChIP_top10000_summit_100window.fasta
head -5 Exhaustive_MEME_MAST_round1to8/GATA_ChIP_top10000_summit_100window.fasta
```

Perform **MEME** on top 10,000 GATA3 peaks with `-minw 4`, `-maxw 20` and the 3-ordered Markov Background Model. \
```{r, engine='bash', eval=F, echo=TRUE}
# MEME
meme -p 48 -oc ${name}_motif.meme_output -nmotifs 1 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 ${name}_summit_100window.fasta
```

The top enriched de novo motif found in the top 10,000 GATA3 peaks match to GATA3. \

```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants 1"}
#library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA_ChIP_top10000_motif.meme_output/logo1.png") 
```

### MAST

After the finding of GATA3-like de novo motif, we will then perform `MAST` to query this motif in all GATA3 peak regions (101bp window), and look for motif coordinates within the peak regions. \
First convert bed filr for all GATA3 peak regions to fasta. \
```{r, engine='bash', eval=F, echo=TRUE}
fastaFromBed -fi $genome -bed ${dir}GATA_ChIP_summit_100window.bed -fo GATA_ChIP_summit_100window.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/GATA_ChIP_summit_100window.fasta
head -6 Exhaustive_MEME_MAST_round1to8/GATA_ChIP_summit_100window.fasta
```

MAST: \
```{r, engine='bash', eval=F, echo=TRUE}
mast -hit_list -best GATA_ChIP_top10000_motif.meme_output/meme.txt GATA_ChIP_summit_100window.fasta > mast_GATA3_PSWM_in_peaks_round1.txt

Rscript /home/FCAM/ssun/scripts/parse_mast_to_coordinates.R mast_GATA3_PSWM_in_peaks_round1.txt
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round1.txt
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round1.txt
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round1.bed 
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round1.bed
```



Then we use `intersectBed` with `-v` option to find GATA3 peaks without GATA3-like motif1 (use the queried motif1 coordinates). \
```{r, engine='bash', eval=F, echo=TRUE}
#peaks without motif1
intersectBed -v -a ${dir}GATA_ChIP_summit_100window.bed -b mast_GATA3_PSWM_in_peaks_round1.bed > without_motifs_1.bed #85440
fastaFromBed -fi $genome -bed without_motifs_1.bed -fo without_motifs_1.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_1.bed
head -3 Exhaustive_MEME_MAST_round1to8/without_motifs_1.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_1.fasta
head -6 Exhaustive_MEME_MAST_round1to8/without_motifs_1.fasta
```


## MEME-Round2:

### find de novo motifs

**Sort** and select the top 10,000 peaks from **GATA3 peaks without motif1**. \
```{r, engine='bash', eval=F, echo=TRUE}
# select top 10000
sort -nrk5,5 without_motifs_1.bed | head -n 10000 > without_motifs_1_top10000.bed
fastaFromBed -fi $genome -bed without_motifs_1_top10000.bed -fo without_motifs_1_top10000.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_1_top10000.bed
head -3 Exhaustive_MEME_MAST_round1to8/without_motifs_1_top10000.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_1_top10000.fasta
head -6 Exhaustive_MEME_MAST_round1to8/without_motifs_1_top10000.fasta
```

Perform **MEME** to find most enriched de novo motif in top 10,000 GATA3 peaks without motif1. \

```{r, engine='bash', eval=F, echo=TRUE}
# MEME-classic
meme -p 48 -oc GATA3_without_motif1_top10000_output -nmotifs 1 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_1_top10000.fasta 
```

The top enriched de novo motif found in the top 10,000 GATA3 peaks (without motif1) match to GATA3. \
```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants 2"}
library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA3_without_motif1_top10000_output/logo1.png") 
```

### MAST

Now we want to use `MAST` to query the 2nd GATA-3 like de novo motif from all GATA3 peaks that do not have GATA3-like motif1. \

```{r, engine='bash', eval=F, echo=TRUE}
mast -hit_list -best GATA3_without_motif1_top10000_output/meme.txt without_motifs_1.fasta > mast_GATA3_PSWM_in_peaks_round2.txt

Rscript /home/FCAM/ssun/scripts/parse_mast_to_coordinates.R mast_GATA3_PSWM_in_peaks_round2.txt
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round2.txt
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round2.txt
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round2.bed #10460
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round2.bed
```

Then we use `intersectBed` with `-v` option to exclude peaks contains GATA3-like motif2 from peaks contains GATA3-like motif1. \

The output file will be GATA3 peak regions (101bp) that do not contain GATA3-like motif 1 and 2. \

```{r, engine='bash', eval=F, echo=TRUE}
#peaks without motif1 and motif2
intersectBed -v -a without_motifs_1.bed -b mast_GATA3_PSWM_in_peaks_round2.bed > without_motifs_12.bed #74979

fastaFromBed -fi $genome -bed without_motifs_12.bed -fo without_motifs_12.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_12.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_12.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_12.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_12.fasta
```


## MEME-Round3:

### find denovo motif with MEME

Again, **sort** and **select** the top 10,000 peaks from GATA3 peaks without motif 1 and 2 (101bp window). \
Then convert .bed to .fasta. \

```{r, engine='bash', eval=F, echo=TRUE}
# select top 10000
sort -nrk5,5 without_motifs_12.bed | head -n 10000 > without_motifs_12_top10000.bed
fastaFromBed -fi $genome -bed without_motifs_12_top10000.bed -fo without_motifs_12_top10000.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_12_top10000.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_12_top10000.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_12_top10000.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_12_top10000.fasta
```

Perform `MEME`. \
```{r, engine='bash', eval=F, echo=TRUE}
# MEME-classic
meme -p 64 -oc GATA3_without_motif12_top10000_output -nmotifs 1 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_12_top10000.fasta 
```

Top motif enriched in top 10,000 peak (exclude the first round and second round GATA motif) match to GATA3 (single sites) \
```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants 3"}
#library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA3_without_motif12_top10000_output/logo1.png") 
```

### MAST 

Query the GATA3-like motif3 from GATA3 peaks without motif 1 and 2 (101bp window) and find motif3 coordinates in peak regions. \
```{r, engine='bash', eval=F, echo=TRUE}
mast -hit_list -best GATA3_without_motif12_top10000_output/meme.txt without_motifs_12.fasta > mast_GATA3_PSWM_in_peaks_round3.txt
Rscript /home/FCAM/ssun/scripts/parse_mast_to_coordinates.R mast_GATA3_PSWM_in_peaks_round3.txt
wc -l mast_GATA3_PSWM_in_peaks_round3.bed #5202
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round3.txt
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round3.txt
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round3.bed
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round3.bed
```

Use `intersectBed` with `-v` to find GATA3 peaks without motif 123. \
```{r, engine='bash', eval=F, echo=TRUE}
#peaks without motif1 and motif2 and motif3
intersectBed -v -a without_motifs_12.bed -b mast_GATA3_PSWM_in_peaks_round3.bed > without_motifs_123.bed #69777
fastaFromBed -fi $genome -bed without_motifs_123.bed -fo without_motifs_123.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123.fasta
```

## brief summary:

In the first 3 rounds of MEME analysis, we are asking MEME to find only 1 de novo motif, and these top enriched motifs match to GATA3. \
 \
In the next few rounds, we will see cases where the top enriched de novo motif found by MEME do not match to GATA3. \
In these cases, we would increase the number of de novo motif we ask MEME to find use `nmotifs` option, and see if the second or third enriched de novo motif match to GATA3. \

## MEME-Round4:

### find 1st de novo motif
Sort and select top 10,000 peaks from GATA3 peaks without GATA3-like motif123. \
```{r, engine='bash', eval=F, echo=TRUE}
# select top 10000
sort -nrk5,5 without_motifs_123.bed | head -n 10000 > without_motifs_123_top10000.bed
fastaFromBed -fi $genome -bed without_motifs_123_top10000.bed -fo without_motifs_123_top10000.fasta
```

```{r, engine='bash', eval=F, echo=TRUE}
# MEME-classic
meme -p 64 -oc GATA3_without_motif123_top10000_output -nmotifs 1 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_123_top10000.fasta 
```

Top motif in top 10,000 peak (exclude the first/second/third round GATA motifs) match to **FOX**. \
```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants 3"}
#library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA3_without_motif123_top10000_output/logo1.png") 
```

### find 2nd de novo motif

repeat previous MEME-classic with `-nmotifs` set to 2. \
```{r, engine='bash', eval=F, echo=TRUE}
# MEME-classic
meme -p 64 -oc GATA3_without_motif123_top10000_output_1 -nmotifs 2 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_123_top10000.fasta
```

Second motif in top 10,000 peak (exclude the first/second/third round GATA motifs) match to GATA3 (4 spaces between half sites) \
```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants 4"}
#library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA3_without_motif123_top10000_output_1/logo2.png") 
```

### MAST

First isolate individual memes from the MEME output meme.txt file. \

```{r, engine='bash', eval=F, echo=TRUE}
wget https://raw.githubusercontent.com/sysunn/siyu_daily_update/main/December_2023/MEME_individual_from_db_python3.py
python MEME_individual_from_db_python3.py -i GATA3_without_motif123_top10000_output_1/meme.txt
        # output: # AGATNDWNAGATARN_meme.txt ---motif4 (match to GATA3)
                  # TRTTTRCTYWD_meme.txt ---FOX

mkdir individual_meme
#MEME-round1 motif1
cp GATA_ChIP_top10000_motif.meme_output/meme.txt individual_meme/GATAmotif1_meme.txt
#MEME-round2 motif2
cp GATA3_without_motif1_top10000_output/meme.txt individual_meme/GATAmotif2_meme.txt
#MEME-round3 motif3
cp GATA3_without_motif12_top10000_output/meme.txt individual_meme/GATAmotif3_meme.txt
#MEME-round4 motif4
cp AGATNDWNAGATARN_meme.txt individual_meme/GATAmotif4_meme.txt

rm *meme.txt
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
cat Exhaustive_MEME_MAST_round1to8/individual_meme/GATAmotif4_meme.txt
```


Use `MAST` to query this GATA3-like motif4 from GATA3 peaks without motif123. \

```{r, engine='bash', eval=F, echo=TRUE}
mast -hit_list -best individual_meme/GATAmotif4_meme.txt without_motifs_123.fasta > mast_GATA3_PSWM_in_peaks_round4.txt #5668

Rscript /home/FCAM/ssun/scripts/parse_mast_to_coordinates.R mast_GATA3_PSWM_in_peaks_round4.txt #5665
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round4.txt
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round4.txt
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round4.bed #5665
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round4.bed 
```

Use `intersectBed` to exclude peaks that contains motif4 from GATA3 peaks without motif 123. \
Then convert to fasta. \

```{r, engine='bash', eval=F, echo=TRUE}
# From peaks (without motif1, 2, 3), exclude peaks with motif4
intersectBed -v -a without_motifs_123.bed -b mast_GATA3_PSWM_in_peaks_round4.bed > without_motifs_1234.bed #64112
fastaFromBed -fi $genome -bed without_motifs_1234.bed -fo without_motifs_1234.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_1234.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_1234.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_1234.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_1234.fasta
```

## MEME-Round5:

### find de novo motif

**Sort** and **select** the top 10,000 peaks from peaks without motif1234. \
And convert to fasta. \

```{r, engine='bash', eval=F, echo=TRUE}
# select top 10000
sort -nrk5,5 without_motifs_1234.bed | head -n 10000 > without_motifs_1234_top10000.bed
fastaFromBed -fi $genome -bed without_motifs_1234_top10000.bed -fo without_motifs_1234_top10000.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_1234_top10000.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_1234_top10000.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_1234_top10000.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_1234_top10000.fasta
```

In previous run, we have already found top enriched de novo motif match to factors other than GATA3. We would expect to see that FOX-like motif reappear in this round. \

Thus, we will search for more motifs (`-nmotifs`) with MEME.


```{r, engine='bash', eval=F, echo=TRUE}
#!/bin/bash
#SBATCH --job-name=meme4.sh    
#SBATCH -N 6
#SBATCH -n 6
#SBATCH -c 16
#SBATCH -p general
#SBATCH --qos=general
#SBATCH --mem=35G
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ssun@uchc.edu
#SBATCH -o streme4.sh_%j.out
#SBATCH -e streme4.sh_%j.err

hostname
export TMPDIR="${HOME}/temp"
module load meme/5.4.1

# MEME-classic
meme -p 96 -oc GATA3_without_motif1234_top10000_output -nmotifs 3 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_1234_top10000.fasta 
```

To confirm if use `nmotif==1`, the top motif will be factor not match with GATA3, I am running this top 10,000 peaks with `-nmotif 1` here. \
```{r, engine='bash', eval=F, echo=TRUE}
meme -p 96 -oc GATA3_without_motif1234_top10000_output_testsingle -nmotifs 1 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_1234_top10000.fasta 
```


While finding only one motif with MEME, we are getting FOX again. \

The third de novo motif found in top 10,000 peak (exclude the 1234 round GATA motifs) match to GATA3. \
```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants 5"}
#library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA3_without_motif1234_top10000_output/logo_rc3.png") 
```

### MAST

First, isolate individual memes from the MEME output meme.txt file. \

```{r, engine='R', eval=F, echo=TRUE}
#wget https://raw.githubusercontent.com/sysunn/siyu_daily_update/main/December_2023/MEME_individual_from_db_python3.py
python MEME_individual_from_db_python3.py -i GATA3_without_motif1234_top10000_output/meme.txt
        # BTTATCWGATB_meme.txt    ---motif5 (match to GATA3)
cp BTTATCWGATB_meme.txt individual_meme/GATAmotif5_meme.txt
rm *meme.txt
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
cat Exhaustive_MEME_MAST_round1to8/individual_meme/GATAmotif5_meme.txt
```

Use `MAST` to query this GATA3-like motif5 from GATA3 peaks without motif 1234 (101bp window) and find the motif coordinates within peak regions. 
```{r, engine='bash', eval=F, echo=TRUE}
# Mast find peaks with motif5
mast -hit_list -best individual_meme/GATAmotif5_meme.txt without_motifs_1234.fasta > mast_GATA3_PSWM_in_peaks_round5.txt
Rscript /home/FCAM/ssun/scripts/parse_mast_to_coordinates.R mast_GATA3_PSWM_in_peaks_round5.txt
wc -l mast_GATA3_PSWM_in_peaks_round5.bed #3564 
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round5.txt
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round5.txt
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round5.bed
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round5.bed
```

Use `intersectBed` to find peaks without GATA3-like motif 12345. \

```{r, engine='bash', eval=F, echo=TRUE}
# From peaks (without motif1, 2, 3,4), exclude peaks with motif5
intersectBed -v -a without_motifs_1234.bed -b mast_GATA3_PSWM_in_peaks_round5.bed > without_motifs_12345.bed #60548
fastaFromBed -fi $genome -bed without_motifs_12345.bed -fo without_motifs_12345.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_12345.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_12345.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_12345.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_12345.fasta
```


## MEME-Round6:

### find de novo motifs

**sort** and **select** top 10,000 peaks from GATA3 peaks without motif12345. \
```{r, engine='bash', eval=F, echo=TRUE}
# select top 10000
sort -nrk5,5 without_motifs_12345.bed | head -n 10000 > without_motifs_12345_top10000.bed
fastaFromBed -fi $genome -bed without_motifs_12345_top10000.bed -fo without_motifs_12345_top10000.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_12345_top10000.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_12345_top10000.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_12345_top10000.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_12345_top10000.fasta
```

Same reason as before, since we have found top enriched de novo motif no longer match to GATA3, we will loosen the `-nmotif` option to 3. \

```{r, engine='R', eval=F, echo=TRUE}
#!/bin/bash
#SBATCH --job-name=meme5.sh    
#SBATCH -N 6
#SBATCH -n 6
#SBATCH -c 16
#SBATCH -p general
#SBATCH --qos=general
#SBATCH --mem=35G
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ssun@uchc.edu
#SBATCH -o meme5.sh_%j.out
#SBATCH -e meme5.sh_%j.err

hostname
export TMPDIR="${HOME}/temp"
module load meme/5.4.1
# MEME-classic
meme -p 96 -oc GATA3_without_motif12345_top10000_output -nmotifs 3 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_12345_top10000.fasta
```

The third de novo motif found in top 10,000 peak (exclude the 12345 round GATA motifs) match to GATA3. \

```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants 6"}
#library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA3_without_motif12345_top10000_output/logo3.png") 
```


### MAST 

First isolate individual memes from the MEME output meme.txt file, and move the GATA3-like motif to a separate folder. \

```{r, engine='bash', eval=F, echo=TRUE}
#wget https://raw.githubusercontent.com/sysunn/siyu_daily_update/main/December_2023/MEME_individual_from_db_python3.py
python MEME_individual_from_db_python3.py -i GATA3_without_motif12345_top10000_output/meme.txt
        # WGATBDHRVAGATAA_meme.txt    ---motif6 (match to GATA3)
cp WGATBDHRVAGATAA_meme.txt individual_meme/GATAmotif6_meme.txt
rm *meme.txt
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
cat Exhaustive_MEME_MAST_round1to8/individual_meme/GATAmotif6_meme.txt
```


Then use `MAST` to query GATA3-like motif6 from GATA3 peaks without motif 12345. \
The output contains the motif coordinated within peak regions (101bp). \

```{r, engine='bash', eval=F, echo=TRUE}
# Mast find peaks with motif6
mast -hit_list -best individual_meme/GATAmotif6_meme.txt without_motifs_12345.fasta > mast_GATA3_PSWM_in_peaks_round6.txt
Rscript /home/FCAM/ssun/scripts/parse_mast_to_coordinates.R mast_GATA3_PSWM_in_peaks_round6.txt
wc -l mast_GATA3_PSWM_in_peaks_round6.bed #4510
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round6.txt
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round6.txt
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round6.bed #4510
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round6.bed
```

Use `intersectBed` with `-v` option to find peaks without motif 123456. \

And convert to fasta. \

```{r, engine='bash', eval=F, echo=TRUE}
# From peaks (without motif1, 2, 3, 4, 5), exclude peaks with motif6
intersectBed -v -a without_motifs_12345.bed -b mast_GATA3_PSWM_in_peaks_round6.bed > without_motifs_123456.bed #56038
fastaFromBed -fi $genome -bed without_motifs_123456.bed -fo without_motifs_123456.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456.fasta
```

## MEME---find no GATA3-like motif

**sort** and select top 10000 from peaks without motif 12345. \

```{r, engine='bash', eval=F, echo=TRUE}
# select top 10000
sort -nrk5,5 without_motifs_123456.bed | head -n 10000 > without_motifs_123456_top10000.bed
fastaFromBed -fi $genome -bed without_motifs_123456_top10000.bed -fo without_motifs_123456_top10000.fasta
```

**-nmotifs 3**
```{r, engine='bash', eval=F, echo=TRUE}
# MEME-classic
meme -p 40 -oc GATA3_without_motif123456_top10000_output -nmotifs 3 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_123456_top10000.fasta
```

`MEME` **did not** find de novo motif match to GATA3. I further increase number of `-nmotif` we ask MEME to find in central 101bp window, and did not get GATA3-like motifs.  \

**-nmotifs 5**
```{r, engine='bash', eval=F, echo=TRUE}
meme -p 40 -oc GATA3_without_motif123456_top10000_output_test -nmotifs 5 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_123456_top10000.fasta

# top 5 motifs do not match with GATA
```


**At this point, MEME no longer reports de novo motifs that match to GATA3 in central 101bp window.** so I moved to the other software---**`STREME`**. \
 

# Exhaustive STREME -MAST for GATA3

## STREME-round7

### find de novo motifs at central 101bp window 

```{r, engine='bash', eval=F, echo=TRUE}
module load meme/5.4.1
# perform STREME on peaks (without motif 1,2,3,4,5,6) (101bp window)
streme --o GATA3_without_123456_streme_output --nmotifs 10 --objfun de --bfile hg38_bkgrnd.txt --dna --minw 4 --maxw 15 --p without_motifs_123456.fasta
```

**STREME found 1 motif (out of 10) that matches to GATA3.** \

```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants 7"}
#library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA3_without_123456_streme_output/4-AGATAAM.png") 
```


### MAST

First, save the STREME-found GATA3-like motif file as `AGATAAM_streme.txt` in `individual_meme` folder. \
```{r, engine='bash', eval=F, echo=TRUE}
wget https://raw.githubusercontent.com/sysunn/siyu_daily_update/main/December_2023/STREME_individual_from_db_python3.py
python STREME_individual_from_db_python3.py -i GATA3_without_123456_streme_output/streme.txt
cp 4-AGATAAM_streme.txt individual_meme/AGATAAM_streme.txt
rm *streme.txt
```


Then use `MAST` to find GATA3-like motif7 (STREME-found) coordinated within peak regions (101bp window). \
Notice that from here, we have increase the p-value stringency to 0.0005 (default is p<0.0001) for `MAST`. \
```{r, engine='bash', eval=F, echo=TRUE}
mast -mt 0.0005 -hit_list -best individual_meme/AGATAAM_streme.txt without_motifs_123456.fasta > mast_GATA3_PSWM_in_peaks_round7.txt #8736
Rscript /home/FCAM/ssun/scripts/parse_mast_to_coordinates.R mast_GATA3_PSWM_in_peaks_round7.txt
wc -l mast_GATA3_PSWM_in_peaks_round7.bed #8733
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round7.txt
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round7.txt
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round7.bed
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round7.bed
```

Use `intersectBed` to find GATA3 peaks without motif 123456 and the STREME-found motif7. \
```{r, engine='bash', eval=F, echo=TRUE}
# From peaks (without motif1, 2, 3, 4, 5, 6), exclude peaks with motif7 (STREME)
intersectBed -v -a without_motifs_123456.bed -b mast_GATA3_PSWM_in_peaks_round7.bed > without_motifs_123456_7.bed #47305
fastaFromBed -fi $genome -bed without_motifs_123456_7.bed -fo without_motifs_123456_7.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_7.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_7.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_7.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_7.fasta
```

## STREME-round8

### find de novo motifs at central 101bp window

Perform `STREME` to peaks without motif 1234567 (central 101bp window). \
```{r, engine='R', eval=F, echo=TRUE}
module load meme/5.4.1
# perform STREME on peaks (without motif 1,2,3,4,5,6, 7) (101bp central window)
streme --oc GATA3_without_123456_7_streme_output --nmotifs 10 --objfun de --bfile hg38_bkgrnd.txt --dna --minw 4 --maxw 15 --p without_motifs_123456_7.fasta
```

**One of the 10 enriched de novo motif match to GATA3.** \

```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants 8"}
#library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA3_without_123456_7_streme_output/6-TGATAA.png") 
```

### MAST
First save the streme motif file as TGATAA_streme.txt in individual_meme folder. \
```{r, engine='bash', eval=F, echo=TRUE}
#wget https://raw.githubusercontent.com/sysunn/siyu_daily_update/main/December_2023/STREME_individual_from_db_python3.py
python STREME_individual_from_db_python3.py -i GATA3_without_123456_7_streme_output/streme.txt
cp 6-TGATAA_streme.txt individual_meme/TGATAA_streme.txt
rm *streme.txt
```


Then use `MAST` to query this motif from all GATA3 peaks without motif 1234567 (101bp window) to find motif coodinates within peak regions. \
```{r, engine='bash', eval=F, echo=TRUE}
# Mast find peaks with motif8 (Streme)
mast -mt 0.0005 -hit_list -best individual_meme/TGATAA_streme.txt without_motifs_123456_7.fasta > mast_GATA3_PSWM_in_peaks_round8.txt
Rscript /home/FCAM/ssun/scripts/parse_mast_to_coordinates.R mast_GATA3_PSWM_in_peaks_round8.txt
wc -l mast_GATA3_PSWM_in_peaks_round8.bed #4452
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round8.txt
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round8.txt
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round8.bed
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round8.bed
```

Use `intersectBed` with `-v` option to find GATA3 peaks without motif 12345678. \
And convert to fasta. \
```{r, engine='bash', eval=F, echo=TRUE}
# From peaks (without motif1, 2, 3, 4, 5, 6, 7), exclude peaks with motif8 (STREME)
intersectBed -v -a without_motifs_123456_7.bed -b mast_GATA3_PSWM_in_peaks_round8.bed > without_motifs_123456_78.bed #42853
fastaFromBed -fi $genome -bed without_motifs_123456_78.bed -fo without_motifs_123456_78.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78.fasta
```

## STREME---find no GATA3-like motif

For peaks without MEME-found motif 1 to 6, and STREME found motif 7,8, we again perform `STREME` to the central 101bp window looking for top 10 de novo motifs. \
```{r, engine='R', eval=F, echo=TRUE}
module load meme/5.4.1
# perform STREME on peaks (without motif 1,2,3,4,5,6, 7, 8) (101bp central window)
streme --oc GATA3_without_123456_78_streme_output --nmotifs 10 --objfun de --bfile hg38_bkgrnd.txt --dna --minw 4 --maxw 15 --p without_motifs_123456_78.fasta
```

**At this point, none of the top 10 de novo motifs found by STREME match to GATA3.** \



# 2-ordered Markov Background Model 

To further increase power of MEME/STREME software finding de novo motifs of our candidate factor GATA3, we also generated a 2-ordered Markov Background Model. \
```{r, engine='bash', eval=F, echo=TRUE}
module load meme/5.4.1
module load bedtools
module load R/4.1.2

genome=/home/FCAM/ssun/Genome/hg38.fa
sizes=/home/FCAM/ssun/Genome/hg38.chrom.sizes

fasta-get-markov -m 2 $genome > hg38_bkgrnd_2mer.txt
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
head Exhaustive_MEME_MAST_round1to8/hg38_bkgrnd_2mer.txt
tail Exhaustive_MEME_MAST_round1to8/hg38_bkgrnd_2mer.txt
```


### MEME with 2-ordered Markov Background Model 


First, **sort** and **select** the top 10,000 peaks from GATA3 peaks without motif12345678 (101bp central window). \

```{r, engine='bash', eval=F, echo=TRUE}
module load meme/5.4.1
# select top 10000
sort -nrk5,5 without_motifs_123456_78.bed | head -n 10000 > without_motifs_123456_78_top10000.bed
fastaFromBed -fi $genome -bed without_motifs_123456_78_top10000.bed -fo without_motifs_123456_78_top10000.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_top10000.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_top10000.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_top10000.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_top10000.fasta
```

Then perform `MEME` to find top enriched de novo motif use the 2-ordered Markov Background Model. \
```{r, engine='bash', eval=F, echo=TRUE}
# MEME-classic
meme -p 32 -o  bkgrnd_2mer_GATA3_without_123456_78_top10000_output -nmotifs 1 -objfun classic -csites 20000 -searchsize 0 -minw 3 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd_2mer.txt -maxsize 100000000 without_motifs_123456_78_top10000.fasta
```

The above MEME generates the top enriched motif using 2mer background, minwidth==3, and top 10000 peaks without 12345678 gives FOS::JUN-like motif. \

**Increase the `nmotif` search to 5**: \

```{r, engine='bash', eval=F, echo=TRUE}
module load meme/5.4.1
# MEME-classic
meme -p 32 -o  bkgrnd_2mer_GATA3_without_123456_78_top10000_output2 -nmotifs 5 -objfun classic -csites 20000 -searchsize 0 -minw 3 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd_2mer.txt -maxsize 100000000 without_motifs_123456_78_top10000.fasta
```

**the top 5 enriched motifs found by MEME do not match GATA3 motifs**. \


### STREME with 2-ordered Markov Background Model 

Perform `STREME` on all peak without 12345678 at central 101bp window with the 2-ordered Markov Background Model . \

```{r, engine='bash', eval=F, echo=TRUE}
module load meme/5.4.1
# perform STREME on peaks (without motif 1,2,3,4,5,6, 7,8) (101bp window)
streme --o bkgrnd_2mer_GATA3_without_123456_78_streme_output --nmotifs 10 --objfun de --bfile hg38_bkgrnd_2mer.txt --dna --minw 4 --maxw 15 --p without_motifs_123456_78.fasta
```


To increase the chance of finding candidate motif, with consideration of a 3mer might be sufficient for GATA3 binding, I change the searching criteria to `--minw 3` and `--maxw 20`. \
```{r, engine='bash', eval=F, echo=TRUE}
module load meme/5.4.1
#streme -oc ZNF143_no_12345.streme_output --maxw 29 --nmotifs 10 --p without_motifs_12345_wide_NNN.fasta
# perform STREME on peaks (without motif 1,2,3,4,5,6, 7,8) (101bp window)
streme --o bkgrnd_2mer_GATA3_without_123456_78_streme_output2 --nmotifs 10 --objfun de --bfile hg38_bkgrnd_2mer.txt --dna --minw 3 --maxw 20 --p without_motifs_123456_78.fasta
```

**the top 10 enriched motifs found by STREME do not match GATA3 motifs**. \

# Increase Width-161

In our previous analysis, we exhaustively conducted MEME/STREME on the central 100bp window of the peak summit to discover de novo motifs matching GATA3. Having identified 6 motifs using MEME and 2 with STREME, we encountered no further GATA-like de novo motifs. \

At this point, we aim to expand the width to 161 total bases, replacing the central 81 bases with 'NNNs', followed by a classic MEME analysis. This adjustment will enable MEME to explore potential GATA3 binding sites in the flanking regions without compromising sensitivity, considering we have thoroughly examined the central sequences and identified no additional GATA-like motifs. \

We chose to replace only 81 bases instead of the full 100bp to maintain a 10bp buffer at each end. This approach allows for potential binding sites that partially overlap the edges of the 100bp window to be accounted for.

```{r, engine='bash', eval=F, echo=TRUE}
module load bedtools
sizes=/home/FCAM/ssun/Genome/hg38.chrom.sizes
genome=/home/FCAM/ssun/Genome/hg38.fa

slopBed -b 30 -i without_motifs_123456_78.bed -g $sizes  | sort -k1,1 -k2,2n > without_motifs_123456_78_161bpwindow.bed

fastaFromBed -fi $genome -bed without_motifs_123456_78_161bpwindow.bed -fo without_motifs_123456_78_161bpwindow.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78.bed

wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_161bpwindow.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_161bpwindow.bed
```

## MEME on full 161 window

Even though we've conducted multiple exhaustive rounds of MEME/STREME, ensuring thorough exploration for all de novo motifs matching GATA3 within the central 100bp peak region, simply widening the MEME search window might not enhance the probability of discovering potential GATA3 motifs across the extended region. This is because expanding the window could reduce MEME's sensitivity in identifying additional motifs at the edges, given the focus on the central 100bp. \

To increase the chance MEME found new binding sites on edges, we could swap the central sequences to Ns (in later analysis). Still, we want to first confirm that we will not getting more GATA3-like de novo motifs at the full increased window (161bp). \

Perform MEME on top 10,000 peaks (full 161bp extended window). \
```{r, engine='bash', eval=F, echo=TRUE}
# select top 10000
sort -nrk5,5 without_motifs_123456_78_161bpwindow.bed | head -n 10000 > without_motifs_123456_78_161bpwindow_top10000.bed
fastaFromBed -fi $genome -bed without_motifs_123456_78_161bpwindow_top10000.bed -fo without_motifs_123456_78_161bpwindow_top10000.fasta
```

```{r, engine='bash', eval=F, echo=TRUE}
#!/bin/bash
#SBATCH --job-name=meme161.sh    
#SBATCH -N 8
#SBATCH -n 8
#SBATCH -c 12
#SBATCH -p general
#SBATCH --qos=general
#SBATCH --mem=30G
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ssun@uchc.edu
#SBATCH -o meme161.sh_%j.out
#SBATCH -e meme161.sh_%j.err

hostname
export TMPDIR="${HOME}/temp"
module load meme/5.4.1

# MEME-classic
meme -p 96 -oc GATA3_without_motifs_123456_78_161bpwindow_top10000_meme_output -nmotifs 5 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_123456_78_161bpwindow_top10000.fasta
```

The top 5 enriched motifs do not match to GATA3 while finding in full 161bp window with MEME. \

## MEME-10,000 peaks-on flanking region

As we discussed earlier, we want to increase MEME's sensitivity in finding motifs at spanned region by replacing the central 81 bp sequences to 50 Ns. \

```{r, engine='bash', eval=F, echo=TRUE}
#161window flank with central 81bp substituted with 50 Ns. 
awk '!/^>/ { mid = int(length($0) / 2); $0 = substr($0, 1, mid - 41) "NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN" substr($0, mid + 41); } 1' without_motifs_123456_78_161bpwindow.fasta > without_motifs_123456_78_161bpwindow_81NNN.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
head -8 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_161bpwindow.fasta
head -8 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_161bpwindow_81NNN.fasta
```

```{r, engine='bash', eval=F, echo=TRUE}
#!/bin/bash
#SBATCH --job-name=streme8N_1.sh    
#SBATCH -N 12
#SBATCH -n 12
#SBATCH -c 8
#SBATCH -p general
#SBATCH --qos=general
#SBATCH --mem=20G
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ssun@uchc.edu
#SBATCH -o streme8N_1.sh_%j.out
#SBATCH -e streme8N_1.sh_%j.err

hostname
export TMPDIR="${HOME}/temp"
module load meme/5.4.1

# MEME-classic
meme -p 96 -oc GATA3_without_motifs_123456_78_161bpwindow_81NNN_top10000_meme_output -nmotifs 5 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_123456_78_161bpwindow_81NNN_top10000.fasta
```

MEME did not find GATA3-like motifs in the top 10,000 peaks' flanking region as well. \

## STREME---full 161 window

```{r, engine='bash', eval=F, echo=TRUE}
#!/bin/bash
#SBATCH --job-name=streme161.sh    
#SBATCH -N 1
#SBATCH -n 1
#SBATCH -c 32
#SBATCH -p himem
#SBATCH --qos=himem
#SBATCH --mem=128G
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ssun@uchc.edu
#SBATCH -o streme161.sh_%j.out
#SBATCH -e streme161.sh_%j.err

hostname
export TMPDIR="${HOME}/temp"
module load meme/5.4.1

streme --o GATA3_without_motifs_123456_78_161bpwindow_streme_output --nmotifs 10 --objfun de --bfile hg38_bkgrnd.txt --dna --minw 4 --maxw 20 --p without_motifs_123456_78_161bpwindow.fasta
```

STREME did not find GATA3-like motifs using the full 161 window. \

## STREME---flanking region
```{r, engine='bash', eval=F, echo=TRUE}
#!/bin/bash
#SBATCH --job-name=streme81N.sh    
#SBATCH -N 1
#SBATCH -n 1
#SBATCH -c 32
#SBATCH -p himem
#SBATCH --qos=himem
#SBATCH --mem=128G
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ssun@uchc.edu
#SBATCH -o streme81N.sh_%j.out
#SBATCH -e streme81N.sh_%j.err

hostname
export TMPDIR="${HOME}/temp"
module load meme/5.4.1

streme --o GATA3_without_motifs_123456_78_161bpwindow_81NNN_streme_output --nmotifs 10 --objfun de --bfile hg38_bkgrnd.txt --dna --minw 4 --maxw 20 --p without_motifs_123456_78_161bpwindow_81NNN.fasta
```

```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants at flanking--STREME"}
#library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA3_without_motifs_123456_78_161bpwindow_81NNN_streme_output/8-WGATDWHATCW.png") 
```

```{r  out.width = "60%", echo=F, fig.align = "center", fig.cap="GATA3 motif variants at flanking--STREME"}
#library(knitr)
knitr::include_graphics("./Exhaustive_MEME_MAST_round1to8/GATA3_without_motifs_123456_78_161bpwindow_81NNN_streme_output/9-GAGATAA.png") 
```

While running STREME on the flanking region, we got similar motifs out on the spanned region. This indicates that the previous 100bp window is not sufficient for finding all potential binding sites. Thus, we will `MAST` on the extended 161bp window (full) for all 8 motifs we found previously and see how many peaks remains. \

# Concatenate files

```{r, engine='bash', eval=F, echo=TRUE}
mkdir individual_meme
#MEME-round1 motif1
cp ../GATA_ChIP_top10000_motif.meme_output/meme.txt individual_meme/GATAmotif1_meme.txt
#MEME-round2 motif2
cp ../GATA3_without_motif1_top10000_output/meme.txt individual_meme/GATAmotif2_meme.txt
#MEME-round3 motif3
cp ../GATA3_without_motif12_top10000_output/meme.txt individual_meme/GATAmotif3_meme.txt
#MEME-round4 motif4
wget https://raw.githubusercontent.com/sysunn/siyu_daily_update/main/December_2023/MEME_individual_from_db_python3.py

python MEME_individual_from_db_python3.py -i ../GATA3_without_motif123_top10000_output_1/meme.txt
        # output: # AGATNDWNAGATARN_meme.txt ---motif4 (match to GATA3)
                  # TRTTTRCTYWD_meme.txt ---FOX
cp AGATNDWNAGATARN_meme.txt individual_meme/GATAmotif4_meme.txt

#MEME-round5 motif5
python MEME_individual_from_db_python3.py -i ../GATA3_without_motif1234_top10000_output/meme.txt
        # BTTATCWGATB_meme.txt    ---motif5 (match to GATA3)
cp BTTATCWGATB_meme.txt individual_meme/GATAmotif5_meme.txt

#MEME-round6 motif6
python MEME_individual_from_db_python3.py -i ../GATA3_without_motif12345_top10000_output/meme.txt
        # WGATBDHRVAGATAA_meme.txt    ---motif6 (match to GATA3)
cp WGATBDHRVAGATAA_meme.txt individual_meme/GATAmotif6_meme.txt


#STREME-round1 motif7
wget https://raw.githubusercontent.com/sysunn/siyu_daily_update/main/December_2023/STREME_individual_from_db_python3.py
python STREME_individual_from_db_python3.py -i ../GATA3_without_123456_streme_output/streme.txt
cp 4-AGATAAM_streme.txt individual_meme/AGATAAM_streme.txt
#STREME-round2 motif8
python STREME_individual_from_db_python3.py -i ../GATA3_without_123456_7_streme_output/streme.txt
cp 6-TGATAA_streme.txt individual_meme/TGATAA_streme.txt

rm *.txt #remove the non-used individual motifs
```


```{r, engine='bash', eval=TRUE, echo=TRUE}
ls Exhaustive_MEME_MAST_round1to8/individual_meme
```

This python script will concatenate all files in your directory, with common headers and each motif's PSWMs. \

```{r, engine='bash', eval=F, echo=TRUE}
wget https://raw.githubusercontent.com/sysunn/siyu_daily_update/main/December_2023/MEME_concatenate_motifs_to_db_python3.py
python MEME_concatenate_motifs_to_db_python3.py individual_meme/ 
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
head -20 Exhaustive_MEME_MAST_round1to8/combined_output_meme.txt
```

## MAST--161bp window

```{r, engine='bash', eval=F, echo=TRUE}
mast -hit_list -best combined_output_meme.txt without_motifs_123456_78_161bpwindow.fasta > mast_GATA3_PSWM_in_peaks_round9.txt 

wget https://raw.githubusercontent.com/sysunn/siyu_daily_update/main/December_2023/parse_multi_mast_to_coordinates.R
Rscript parse_multi_mast_to_coordinates.R mast_GATA3_PSWM_in_peaks_round9.txt 8
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round9.txt 
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round9.txt 
wc -l Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round9.bed #6002
head -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round9.bed
tail -5 Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round9.bed
awk '{print $7}' Exhaustive_MEME_MAST_round1to8/mast_GATA3_PSWM_in_peaks_round9.bed | sort | uniq
```

Use `intersectBed` with `-v` option to find peaks (161bp window) without motif 12345678. \

And convert to fasta. \

```{r, engine='bash', eval=F, echo=TRUE}
# From peaks (without motif1, 2, 3, 4, 5, 6, 7, 8) (101bp window), exclude peaks with any of the motifs found in 161bp window
intersectBed -v -a without_motifs_123456_78_161bpwindow.bed -b mast_GATA3_PSWM_in_peaks_round9.bed > without_motifs_123456_78_161bp_mast.bed #37308 
fastaFromBed -fi $genome -bed without_motifs_123456_78_161bp_mast.bed -fo without_motifs_123456_78_161bp_mast.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_161bp_mast.bed
head -3 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_161bp_mast.bed
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_161bp_mast.fasta
head -6 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_161bp_mast.fasta
```

# Increase Width-181

In the previous analysis, we exhaustively ran MEME/STREME in a 101 bp window and found no GATA3-like motifs. We then extended the window from 101 bp to 161 bp and discovered similar motifs in the flanking region. This indicates that the previous 101 bp window was not large enough to find all possible binding sites of GATA3. \

Now, after using `MAST` on all MEME/STREME found motifs in the 161 bp window, we are extending the width to 181 bp. Our aim is to perform a similar analysis to see if increasing the width to a 181 bp window will enable MEME/STREME to discover more possible binding sites. \

```{r, engine='bash', eval=F, echo=TRUE}
module load bedtools
sizes=/home/FCAM/ssun/Genome/hg38.chrom.sizes
genome=/home/FCAM/ssun/Genome/hg38.fa

slopBed -b 10 -i without_motifs_123456_78_161bp_mast.bed -g $sizes  | sort -k1,1 -k2,2n > without_motifs_123456_78_181bpwindow.bed

fastaFromBed -fi $genome -bed without_motifs_123456_78_181bpwindow.bed -fo without_motifs_123456_78_181bpwindow.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_181bpwindow.bed
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_181bpwindow.bed

wc -l Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_181bpwindow.fasta
head -5 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_181bpwindow.fasta
```

## MEME-10,000 peaks on full 181 window

Perform MEME on top 10,000 peaks (full 181bp extended window). \
```{r, engine='bash', eval=F, echo=TRUE}
# select top 10000
sort -nrk5,5 without_motifs_123456_78_181bpwindow.bed | head -n 10000 > without_motifs_123456_78_181bpwindow_top10000.bed
fastaFromBed -fi $genome -bed without_motifs_123456_78_181bpwindow_top10000.bed -fo without_motifs_123456_78_181bpwindow_top10000.fasta
```

```{r, engine='bash', eval=F, echo=TRUE}
#!/bin/bash
#SBATCH --job-name=meme181_1.sh    
#SBATCH -N 8
#SBATCH -n 8
#SBATCH -c 25
#SBATCH -p general
#SBATCH --qos=general
#SBATCH --mem=50G
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ssun@uchc.edu
#SBATCH -o meme181_1.sh_%j.out
#SBATCH -e meme181_1.sh_%j.err

hostname
export TMPDIR="${HOME}/temp"
module load meme/5.4.1

# MEME-classic
meme -p 200 -oc GATA3_without_motifs_123456_78_181bpwindow_top10000_meme_output1 -nmotifs 5 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_123456_78_181bpwindow_top10000.fasta
```



## MEME-10,000 peaks-on flanking region

As we discussed earlier, we want to increase MEME's sensitivity in finding motifs at spanned region by replacing the central 141 bp sequences to 50 Ns. \

```{r, engine='bash', eval=F, echo=TRUE}
#181window flank with central 141bp substituted with 50 Ns. 
awk '!/^>/ { mid = int(length($0) / 2); $0 = substr($0, 1, mid - 71) "NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN" substr($0, mid + 71); } 1' without_motifs_123456_78_181bpwindow_top10000.fasta > without_motifs_123456_78_181bpwindow_top10000_141NNN.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
head -8 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_181bpwindow_top10000.fasta
head -8 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_181bpwindow_top10000_141NNN.fasta
```

```{r, engine='bash', eval=F, echo=TRUE}
#!/bin/bash
#SBATCH --job-name=meme181_N1.sh    
#SBATCH -N 8
#SBATCH -n 8
#SBATCH -c 20
#SBATCH -p general
#SBATCH --qos=general
#SBATCH --mem=40G
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ssun@uchc.edu
#SBATCH -o meme181_N1.sh_%j.out
#SBATCH -e meme181_N1.sh_%j.err

hostname
export TMPDIR="${HOME}/temp"
module load meme/5.4.1

# MEME-classic
meme -p 160 -oc GATA3_without_motifs_123456_78_181bpwindow_141NNN_top10000_meme_output1 -nmotifs 5 -objfun classic -csites 20000 -searchsize 0 -minw 4 -maxw 20 -revcomp -dna -bfile hg38_bkgrnd.txt -maxsize 100000000 without_motifs_123456_78_181bpwindow_top10000_141NNN.fasta
```

No GATA3-like motifs found. \

*While trying to search for `nmotifs 10` with parallel running, sbatch job failure: "Fatal error in PMPI_Allreduce". But use `nmotifs 5` is fine. \

## STREME---full 181bp

```{r, engine='bash', eval=F, echo=TRUE}
#!/bin/bash
#SBATCH --job-name=streme181.sh    
#SBATCH -N 1
#SBATCH -n 1
#SBATCH -c 32
#SBATCH -p general
#SBATCH --qos=general
#SBATCH --mem=128G
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ssun@uchc.edu
#SBATCH -o streme181.sh_%j.out
#SBATCH -e streme181.sh_%j.err

hostname
export TMPDIR="${HOME}/temp"
module load meme/5.4.1

streme --o GATA3_without_motifs_123456_78_181bpwindow_streme_output --nmotifs 10 --objfun de --bfile hg38_bkgrnd.txt --dna --minw 4 --maxw 20 --p without_motifs_123456_78_181bpwindow.fasta
```

## STREME---flanking

```{r, engine='bash', eval=F, echo=TRUE}
#181window flank with central 141bp substituted with 50 Ns. 
awk '!/^>/ { mid = int(length($0) / 2); $0 = substr($0, 1, mid - 71) "NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN" substr($0, mid + 71); } 1' without_motifs_123456_78_181bpwindow.fasta > without_motifs_123456_78_181bpwindow_141NNN.fasta
```

```{r, engine='bash', eval=TRUE, echo=TRUE}
head -8 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_181bpwindow.fasta
head -8 Exhaustive_MEME_MAST_round1to8/without_motifs_123456_78_181bpwindow_141NNN.fasta
```

```{r, engine='bash', eval=F, echo=TRUE}
#!/bin/bash
#SBATCH --job-name=streme181_N.sh    
#SBATCH -N 1
#SBATCH -n 1
#SBATCH -c 32
#SBATCH -p general
#SBATCH --qos=general
#SBATCH --mem=128G
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ssun@uchc.edu
#SBATCH -o streme181_N.sh_%j.out
#SBATCH -e streme181_N.sh_%j.err

hostname
export TMPDIR="${HOME}/temp"
module load meme/5.4.1

streme --o GATA3_without_motifs_123456_78_181bpwindow_141NNN_streme_output --nmotifs 10 --objfun de --bfile hg38_bkgrnd.txt --dna --minw 4 --maxw 20 --p without_motifs_123456_78_181bpwindow_141NNN.fasta
```


STREME for the full 181 window and flanking region (central 141bp swapped to N) both found a motif with a "GAT" in it. I am not sure if we should consider it as a possible GATA3 binding site. \


<span class="highlighted">If we think this is a potential binding site for GATA3, then the next step would be to further extend the width to 200bp and search for de novo binding sites.</span> \
<span class="highlighted">If we do not think this is a potential binding site, then we can conclude that: GATA3 can bind **within 161bp** window around peak summit. Among the 96868 peaks called by MACS3, we have **~38.5%** GATA3 peaks do not contain MEME/STREME found GATA3 motifs.</span> \
<span class="highlighted">Then we can perform the kmer analysis to these 38.5% peaks and see if we can find specific GATA3 binding elements.</span> \
